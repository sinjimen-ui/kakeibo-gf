<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>å®¶è¨ˆç°¿</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg: #fff7fb;
      --card: #ffffffcc;
      --ink: #2b2b2b;
      --muted:#6b6b6b;
      --accent:#ff5aa5;
      --accent2:#7c5cff;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 20% -10%, #ffd1e6 0%, transparent 55%),
        radial-gradient(1200px 800px at 100% 0%, #d9d2ff 0%, transparent 55%),
        var(--bg);
      padding: env(safe-area-inset-top) 12px calc(76px + env(safe-area-inset-bottom)) 12px;
    }
    h1{font-size:18px; margin:8px 4px 12px}
    .wrap{max-width:520px; margin:0 auto;}
    .grid{display:grid; gap:12px;}
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.6);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      padding:14px;
    }
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px;}
    input, select, button{
      width:100%;
      font-size:16px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      outline:none;
    }
    input:focus, select:focus{border-color:rgba(255,90,165,.45); box-shadow:0 0 0 4px rgba(255,90,165,.12)}
    .btn{
      border:none;
      background: linear-gradient(135deg, var(--accent), #ff86c2);
      color:white;
      font-weight:800;
      box-shadow: 0 10px 20px rgba(255,90,165,.25);
      cursor:pointer;
    }
    .btn:active{transform: translateY(1px)}
    .btn-secondary{
      border:none;
      background: linear-gradient(135deg, var(--accent2), #a08cff);
      color:white;
      font-weight:800;
      box-shadow: 0 10px 20px rgba(124,92,255,.22);
      cursor:pointer;
    }
    .btn-mini{
      width:auto; flex:0 0 auto;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.06);
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      font-size:12px;
      color:var(--muted);
    }
    .money{font-size:22px; font-weight:900; letter-spacing:.2px;}
    .sub{font-size:12px; color:var(--muted);}
    .seg{
      display:flex; gap:8px;
      background:#fff;
      padding:6px; border-radius:999px;
      border:1px solid rgba(0,0,0,.06);
    }
    .seg button{
      padding:10px 10px;
      border-radius:999px;
      border:none;
      background:transparent;
      font-weight:900;
      color:var(--muted);
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(255,90,165,.14);
      color: #b70055;
    }
    .list{display:grid; gap:8px; margin-top:10px;}
    .item{
      display:flex; gap:10px; align-items:center;
      padding:12px;
      border-radius:16px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
    }
    .emoji{font-size:20px; width:34px; text-align:center;}
    .meta{flex:1; min-width:0;}
    .meta .top{display:flex; justify-content:space-between; gap:10px; align-items:baseline;}
    .meta .name{
      font-weight:900;
      white-space: nowrap;
      writing-mode: horizontal-tb; /* doTERRAã ã‘è‹±å­—ã§ã‚‚OK */
      overflow: hidden;
      text-overflow: ellipsis;
      min-width:0;
      max-width: 100%;
    }
    .meta .small{font-size:12px; color:var(--muted);}
    .yen{font-weight:900; white-space:nowrap;}
    .del{
      width:auto; flex:0 0 auto;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.06);
      background:#fff;
      cursor:pointer;
      color:#c43b3b;
      font-weight:900;
    }

    .kv{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
    }
    .kv .k{color:var(--muted); font-size:12px; font-weight:800;}
    .kv .v{font-weight:900; white-space:nowrap;}

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:420px){
      .two{grid-template-columns:1fr;}
    }

    .nav{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom)) 12px;
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(12px);
      border-top:1px solid rgba(0,0,0,.06);
    }
    .nav .inner{max-width:520px; margin:0 auto; display:flex; gap:10px;}
    .nav button{padding:12px; border-radius:16px; font-weight:900}
    .hide{display:none}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>å®¶è¨ˆç°¿</h1>

    <!-- Month summary -->
    <div class="card grid">
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div>
          <div class="row" style="gap:8px; align-items:center; justify-content:flex-start;">
            <button class="btn-mini" id="prevMonth" type="button">â—€ï¸</button>
            <div class="pill" id="monthLabel">ğŸ“… ä»Šæœˆ</div>
            <button class="btn-mini" id="nextMonth" type="button">â–¶ï¸</button>
          </div>

          <div class="money" id="monthTotal">Â¥0</div>
          <div class="sub" id="monthNote">å…¨éƒ¨ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‹éŠ€è¡Œï¼‹ç¾é‡‘ï¼‰</div>
        </div>

        <div style="max-width:260px;">
          <label>è¡¨ç¤º</label>
          <div class="seg">
            <button id="viewAll" class="active" type="button">å…¨éƒ¨</button>
            <button id="viewCard" type="button">ã‚«ãƒ¼ãƒ‰</button>
            <button id="viewBank" type="button">éŠ€è¡Œ</button>
            <button id="viewCash" type="button">ç¾é‡‘</button>
          </div>
        </div>
      </div>

      <canvas id="pie" height="220"></canvas>

      <!-- NEW: æœˆã®ã‚«ãƒ¼ãƒ‰åˆ¥/éŠ€è¡Œåˆ¥ åˆè¨ˆï¼ˆ1ç”»é¢è¡¨ç¤ºï¼‰ -->
      <div class="two" id="monthBreakdown">
        <div class="grid" style="gap:8px;">
          <div class="pill">ğŸ’³ ã‚«ãƒ¼ãƒ‰åˆ¥ åˆè¨ˆ</div>
          <div id="cardTotals" class="grid" style="gap:8px;"></div>
          <div class="sub" id="cardTotalsNote"></div>
        </div>
        <div class="grid" style="gap:8px;">
          <div class="pill">ğŸ¦ éŠ€è¡Œåˆ¥ åˆè¨ˆ</div>
          <div id="bankTotals" class="grid" style="gap:8px;"></div>
          <div class="sub" id="bankTotalsNote"></div>
        </div>
      </div>
    </div>

    <!-- Add entry -->
    <div class="card grid" id="screenAdd">
      <div class="row">
        <div>
          <label>æ—¥ä»˜</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
          <input id="amount" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š1280" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>ã‚«ãƒ†ã‚´ãƒª</label>
          <select id="category"></select>
        </div>
        <div>
          <label>æ”¯æ‰•ã„</label>
          <select id="payType">
            <option value="card">ğŸ’³ ã‚«ãƒ¼ãƒ‰</option>
            <option value="bank">ğŸ¦ éŠ€è¡Œ</option>
            <option value="cash">ğŸ’µ ç¾é‡‘</option>
          </select>
        </div>
      </div>

      <div class="row" id="cardBrandRow">
        <div>
          <label>ã‚«ãƒ¼ãƒ‰ä¼šç¤¾ï¼ˆã‚«ãƒ¼ãƒ‰ã®æ™‚ã ã‘ï¼‰</label>
          <select id="cardBrandSelect"></select>
        </div>
      </div>

      <div class="row" id="bankRow" style="display:none;">
        <div>
          <label>éŠ€è¡Œï¼ˆéŠ€è¡Œæ”¯æ‰•ã„ã®æ™‚ã ã‘ï¼‰</label>
          <select id="bankSelect"></select>
        </div>
      </div>

      <div>
        <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <input id="memo" type="text" placeholder="ä¾‹ï¼šã‚¹ãƒ¼ãƒ‘ãƒ¼ / ãƒ©ãƒ³ãƒ / Amazonâ€¦" />
      </div>

      <button class="btn" id="addBtn" type="button">â• è¿½åŠ </button>
      <div class="sub">â€» è¿½åŠ ã—ãŸæ˜ç´°ã®æœˆã«è‡ªå‹•ã§ç§»å‹•ã—ã¾ã™ã€‚</div>
    </div>

    <!-- List -->
    <div class="card" id="screenList">
      <div class="row" style="justify-content:space-between;">
        <div class="pill">ğŸ§¾ æ˜ç´°</div>
        <button class="btn-secondary" id="exportBtn" type="button" style="max-width:160px;">ğŸ“¤ CSV</button>
      </div>
      <div class="list" id="list"></div>
      <div class="sub" style="margin-top:8px;">â€» ç«¯æœ«å†…ã«ä¿å­˜ã€‚æ©Ÿç¨®å¤‰æ›´å‰ã¯CSVãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨ã€‚</div>
    </div>

    <!-- Settings -->
    <div class="card hide" id="screenSettings">
      <div class="pill">âš™ï¸ ç®¡ç†</div>

      <!-- Category management -->
      <div class="pill" style="margin-top:12px;">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>çµµæ–‡å­—</label>
          <input id="newEmoji" type="text" placeholder="ä¾‹ï¼šğŸŒ¿" maxlength="2" />
        </div>
        <div>
          <label>ã‚«ãƒ†ã‚´ãƒªå</label>
          <input id="newCat" type="text" placeholder="ä¾‹ï¼šæ—¥ç”¨å“" />
        </div>
      </div>
      <button class="btn" id="addCatBtn" type="button">â• ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
      <div class="list" id="catList" style="margin-top:10px;"></div>
      <div class="sub">â€» ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚«ãƒ†ã‚´ãƒªã¯å‰Šé™¤ã§ãã¾ã›ã‚“ï¼ˆæ˜ç´°ã‚’å…ˆã«å‰Šé™¤ã—ã¦ãã ã•ã„ï¼‰ã€‚</div>

      <!-- Card management (NEW) -->
      <div class="pill" style="margin-top:18px;">ğŸ’³ ã‚«ãƒ¼ãƒ‰ä¼šç¤¾ç®¡ç†</div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>ã‚«ãƒ¼ãƒ‰ä¼šç¤¾å</label>
          <input id="newCardBrand" type="text" placeholder="ä¾‹ï¼šæ¥½å¤© / JCB / etc..." />
        </div>
      </div>
      <button class="btn" id="addCardBrandBtn" type="button">â• ã‚«ãƒ¼ãƒ‰ä¼šç¤¾è¿½åŠ </button>
      <div class="list" id="cardBrandList" style="margin-top:10px;"></div>
      <div class="sub">â€» ä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ä¼šç¤¾ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ï¼ˆæ˜ç´°ã‚’å…ˆã«å‰Šé™¤ã—ã¦ãã ã•ã„ï¼‰ã€‚</div>

      <!-- Bank management -->
      <div class="pill" style="margin-top:18px;">ğŸ¦ éŠ€è¡Œç®¡ç†</div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>éŠ€è¡Œå</label>
          <input id="newBank" type="text" placeholder="ä¾‹ï¼šâ—¯â—¯éŠ€è¡Œ" />
        </div>
      </div>
      <button class="btn" id="addBankBtn" type="button">â• éŠ€è¡Œè¿½åŠ </button>
      <div class="list" id="bankList" style="margin-top:10px;"></div>
      <div class="sub">â€» ä½¿ã‚ã‚Œã¦ã„ã‚‹éŠ€è¡Œã¯å‰Šé™¤ã§ãã¾ã›ã‚“ï¼ˆæ˜ç´°ã‚’å…ˆã«å‰Šé™¤ã—ã¦ãã ã•ã„ï¼‰ã€‚</div>
    </div>
  </div>

  <!-- bottom nav -->
  <div class="nav">
    <div class="inner">
      <button class="btn" id="navAdd" type="button">â• å…¥åŠ›</button>
      <button class="btn-secondary" id="navSettings" type="button">âš™ï¸ ç®¡ç†</button>
    </div>
  </div>

<script>
/** Storage key */
const KEY = "kakeibo_gf_v3";

/** Utils */
function rid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function yen(n){ return "Â¥" + (n||0).toLocaleString("ja-JP"); }
function toISODate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

/** Defaults */
function defaultCategories(){
  return [
    { id: rid(), emoji:"ğŸš", name:"é£Ÿè²»" },
    { id: rid(), emoji:"â˜•", name:"ã‚«ãƒ•ã‚§" },
    { id: rid(), emoji:"ğŸšƒ", name:"äº¤é€š" },
    { id: rid(), emoji:"ğŸ›ï¸", name:"è²·ã„ç‰©" },
    { id: rid(), emoji:"ğŸ ", name:"å®¶" },
    { id: rid(), emoji:"ğŸ", name:"ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ" },
    { id: rid(), emoji:"ğŸ’„", name:"ç¾å®¹" },
    { id: rid(), emoji:"ğŸ®", name:"è¶£å‘³" },
    { id: rid(), emoji:"ğŸŒ¿", name:"doTERRA" },
  ];
}
function defaultBanks(){
  return [
    { id: rid(), name: "ä¸‰è±UFJéŠ€è¡Œ" },
    { id: rid(), name: "åå¤å±‹éŠ€è¡Œ" },
    { id: rid(), name: "ç€¬æˆ¸éŠ€è¡Œ" },
  ];
}
function defaultCardBrands(){
  return [
    { id: rid(), name: "æ¥½å¤©" },
    { id: rid(), name: "ä¸‰äº•ä½å‹" },
    { id: rid(), name: "JCB" },
    { id: rid(), name: "dã‚«ãƒ¼ãƒ‰" },
    { id: rid(), name: "PayPayã‚«ãƒ¼ãƒ‰" },
    { id: rid(), name: "ãã®ä»–" },
  ];
}

/** State */
let state = loadState();

/** Month nav */
let selectedYear = (new Date()).getFullYear();
let selectedMonth = (new Date()).getMonth();

/** View mode */
let viewMode = "all"; // all | card | bank | cash

/** Chart */
let pieChart = null;

/** UI refs */
const $date = document.getElementById("date");
const $amount = document.getElementById("amount");
const $category = document.getElementById("category");
const $payType = document.getElementById("payType");

const $cardBrandRow = document.getElementById("cardBrandRow");
const $cardBrandSelect = document.getElementById("cardBrandSelect");

const $bankRow = document.getElementById("bankRow");
const $bankSelect = document.getElementById("bankSelect");

const $memo = document.getElementById("memo");
const $addBtn = document.getElementById("addBtn");

const $monthLabel = document.getElementById("monthLabel");
const $monthTotal = document.getElementById("monthTotal");
const $monthNote = document.getElementById("monthNote");

const $cardTotals = document.getElementById("cardTotals");
const $bankTotals = document.getElementById("bankTotals");
const $cardTotalsNote = document.getElementById("cardTotalsNote");
const $bankTotalsNote = document.getElementById("bankTotalsNote");

const $list = document.getElementById("list");

const $viewAll = document.getElementById("viewAll");
const $viewCard = document.getElementById("viewCard");
const $viewBank = document.getElementById("viewBank");
const $viewCash = document.getElementById("viewCash");

const $exportBtn = document.getElementById("exportBtn");

const $screenAdd = document.getElementById("screenAdd");
const $screenList = document.getElementById("screenList");
const $screenSettings = document.getElementById("screenSettings");
const $navAdd = document.getElementById("navAdd");
const $navSettings = document.getElementById("navSettings");

const $newEmoji = document.getElementById("newEmoji");
const $newCat = document.getElementById("newCat");
const $addCatBtn = document.getElementById("addCatBtn");
const $catList = document.getElementById("catList");

const $newBank = document.getElementById("newBank");
const $addBankBtn = document.getElementById("addBankBtn");
const $bankList = document.getElementById("bankList");

const $newCardBrand = document.getElementById("newCardBrand");
const $addCardBrandBtn = document.getElementById("addCardBrandBtn");
const $cardBrandList = document.getElementById("cardBrandList");

const $prevMonth = document.getElementById("prevMonth");
const $nextMonth = document.getElementById("nextMonth");

/* -------------------- Init -------------------- */
init();
function init(){
  $date.value = toISODate(new Date());
  renderCategorySelect();
  renderBankSelect();
  renderCardBrandSelect();
  bindEvents();
  syncPaymentVisibility();
  renderAll();
}

/* -------------------- Events -------------------- */
function bindEvents(){
  $addBtn.addEventListener("click", onAdd);

  $payType.addEventListener("change", ()=>{
    syncPaymentVisibility();
  });

  [$viewAll,$viewCard,$viewBank,$viewCash].forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const mode = btn.id === "viewAll" ? "all" :
                   btn.id === "viewCard" ? "card" :
                   btn.id === "viewBank" ? "bank" : "cash";
      setViewMode(mode);
    });
  });

  $exportBtn.addEventListener("click", exportCSV);

  $navAdd.addEventListener("click", ()=>{
    $screenSettings.classList.add("hide");
    $screenAdd.classList.remove("hide");
    $screenList.classList.remove("hide");
  });

  $navSettings.addEventListener("click", ()=>{
    $screenSettings.classList.remove("hide");
    $screenAdd.classList.remove("hide");
    $screenList.classList.add("hide");
    renderCatList();
    renderBankList();
    renderCardBrandList();
  });

  $addCatBtn.addEventListener("click", ()=>{
    const emoji = ($newEmoji.value || "").trim();
    const name = ($newCat.value || "").trim();
    if(!name) return alert("ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥ã‚Œã¦ã­ğŸ«¶");
    state.categories.push({ id: rid(), emoji: emoji || "âœ¨", name });
    saveState();
    $newEmoji.value = "";
    $newCat.value = "";
    renderCategorySelect();
    renderCatList();
    renderAll();
  });

  $addBankBtn.addEventListener("click", ()=>{
    const name = ($newBank.value || "").trim();
    if(!name) return alert("éŠ€è¡Œåã‚’å…¥ã‚Œã¦ã­ğŸ«¶");
    state.banks.push({ id: rid(), name });
    saveState();
    $newBank.value = "";
    renderBankSelect();
    renderBankList();
    renderAll();
  });

  $addCardBrandBtn.addEventListener("click", ()=>{
    const name = ($newCardBrand.value || "").trim();
    if(!name) return alert("ã‚«ãƒ¼ãƒ‰ä¼šç¤¾åã‚’å…¥ã‚Œã¦ã­ğŸ«¶");
    state.cardBrands.push({ id: rid(), name });
    saveState();
    $newCardBrand.value = "";
    renderCardBrandSelect();
    renderCardBrandList();
    renderAll();
  });

  $prevMonth.addEventListener("click", ()=>{ shiftMonth(-1); renderAll(); });
  $nextMonth.addEventListener("click", ()=>{ shiftMonth(+1); renderAll(); });
}

/* -------------------- Month helpers -------------------- */
function shiftMonth(delta){
  selectedMonth += delta;
  if(selectedMonth < 0){ selectedMonth = 11; selectedYear -= 1; }
  if(selectedMonth > 11){ selectedMonth = 0; selectedYear += 1; }
}
function selectedYM(){
  const m = String(selectedMonth + 1).padStart(2,"0");
  return `${selectedYear}-${m}`;
}
function selectedJPLabel(){
  return `${selectedYear}å¹´${selectedMonth+1}æœˆ`;
}

/* -------------------- Actions -------------------- */
function onAdd(){
  const date = $date.value;
  const amount = Number($amount.value);
  const categoryId = $category.value;
  const payType = $payType.value;

  const cardBrandId = payType === "card" ? ($cardBrandSelect.value || "") : "";
  const bankId = payType === "bank" ? ($bankSelect.value || "") : "";
  const memo = ($memo.value || "").trim();

  if(!date) return alert("æ—¥ä»˜ã‚’å…¥ã‚Œã¦ã­ğŸ“…");
  if(!amount || amount <= 0) return alert("é‡‘é¡ã‚’å…¥ã‚Œã¦ã­ğŸ’°");
  if(!categoryId) return alert("ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ã­âœ¨");
  if(payType === "bank" && !bankId) return alert("éŠ€è¡Œã‚’é¸ã‚“ã§ã­ğŸ¦");
  if(payType === "card" && !cardBrandId) return alert("ã‚«ãƒ¼ãƒ‰ä¼šç¤¾ã‚’é¸ã‚“ã§ã­ğŸ’³");

  state.entries.push({
    id: rid(),
    date,
    amount,
    categoryId,
    payType,        // card | bank | cash
    cardBrandId,    // card only
    bankId,         // bank only
    memo
  });
  saveState();

  $amount.value = "";
  $memo.value = "";

  const d = new Date(date + "T00:00:00");
  selectedYear = d.getFullYear();
  selectedMonth = d.getMonth();

  renderAll();
}

/* -------------------- Rendering -------------------- */
function renderAll(){
  $monthLabel.textContent = `ğŸ“… ${selectedJPLabel()}`;
  $monthNote.textContent =
    viewMode === "all"  ? "å…¨éƒ¨ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‹éŠ€è¡Œï¼‹ç¾é‡‘ï¼‰" :
    viewMode === "card" ? "ã‚«ãƒ¼ãƒ‰ã®ã¿" :
    viewMode === "bank" ? "éŠ€è¡Œã®ã¿" : "ç¾é‡‘ã®ã¿";

  const entries = getSelectedMonthEntries(viewMode);
  $monthTotal.textContent = yen(entries.reduce((s,e)=>s+e.amount,0));

  renderList(entries);
  renderPie(entries);
  renderMonthTotalsByCardAndBank(getSelectedMonthEntries("all")); // 1ç”»é¢ã§ã‚«ãƒ¼ãƒ‰/éŠ€è¡Œåˆ¥åˆè¨ˆã¯å¸¸ã«æœˆå…¨ä½“ã‚’è¡¨ç¤º
}

function renderCategorySelect(){
  $category.innerHTML = "";
  state.categories.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = `${c.emoji} ${c.name}`;
    $category.appendChild(opt);
  });
}

function renderBankSelect(){
  $bankSelect.innerHTML = "";
  state.banks.forEach(b=>{
    const opt = document.createElement("option");
    opt.value = b.id;
    opt.textContent = b.name;
    $bankSelect.appendChild(opt);
  });
}

function renderCardBrandSelect(){
  $cardBrandSelect.innerHTML = "";
  state.cardBrands.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    $cardBrandSelect.appendChild(opt);
  });
}

function renderList(entries){
  $list.innerHTML = "";
  if(entries.length === 0){
    const div = document.createElement("div");
    div.className = "sub";
    div.textContent = "ã“ã®æœˆã®æ˜ç´°ã¯ã¾ã ãªã„ã‚ˆã€‚ä¸‹ã§è¿½åŠ ã—ã¦ã­ğŸ«¶";
    $list.appendChild(div);
    return;
  }

  const sorted = [...entries].sort((a,b)=> (a.date < b.date ? 1 : -1));
  sorted.forEach(e=>{
    const cat = state.categories.find(c=>c.id===e.categoryId);
    const row = document.createElement("div");
    row.className = "item";

    const emoji = document.createElement("div");
    emoji.className = "emoji";
    emoji.textContent = cat?.emoji || "âœ¨";

    const meta = document.createElement("div");
    meta.className = "meta";

    const top = document.createElement("div");
    top.className = "top";

    const name = document.createElement("div");
    name.className = "name";

    const payBadge = e.payType === "bank" ? "ğŸ¦" : (e.payType === "cash" ? "ğŸ’µ" : "ğŸ’³");

    let extra = "";
    if(e.payType === "card"){
      const cb = state.cardBrands.find(x=>x.id===e.cardBrandId);
      extra = cb ? `ï¼ˆ${cb.name}ï¼‰` : "ï¼ˆæœªè¨­å®šï¼‰";
    }
    if(e.payType === "bank"){
      const b = state.banks.find(x=>x.id===e.bankId);
      extra = b ? `ï¼ˆ${b.name}ï¼‰` : "";
    }

    name.textContent = `${cat?.name || "ã‚«ãƒ†ã‚´ãƒª"} ${payBadge}${extra}`;

    const price = document.createElement("div");
    price.className = "yen";
    price.textContent = yen(e.amount);

    top.appendChild(name);
    top.appendChild(price);

    const small = document.createElement("div");
    small.className = "small";
    small.textContent = `${e.date}${e.memo ? "ãƒ»"+e.memo : ""}`;

    meta.appendChild(top);
    meta.appendChild(small);

    const del = document.createElement("button");
    del.className = "del";
    del.type = "button";
    del.textContent = "å‰Šé™¤";
    del.addEventListener("click", ()=>{
      const ok = confirm("ã“ã‚Œæ¶ˆã™ï¼ŸğŸ¥º");
      if(!ok) return;
      state.entries = state.entries.filter(x=>x.id !== e.id);
      saveState();
      renderAll();
      if(!$screenSettings.classList.contains("hide")){
        renderCatList();
        renderBankList();
        renderCardBrandList();
      }
    });

    row.appendChild(emoji);
    row.appendChild(meta);
    row.appendChild(del);
    $list.appendChild(row);
  });
}

function renderPie(entries){
  const sums = new Map();
  for(const e of entries){
    sums.set(e.categoryId, (sums.get(e.categoryId) || 0) + e.amount);
  }

  const labels = [];
  const data = [];
  for(const [cid, amt] of sums.entries()){
    const cat = state.categories.find(c=>c.id===cid);
    labels.push(`${cat?.emoji || "âœ¨"} ${cat?.name || "ã‚«ãƒ†ã‚´ãƒª"}`);
    data.push(amt);
  }

  const ctx = document.getElementById("pie");
  if(pieChart) pieChart.destroy();

  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: labels.length ? labels : ["ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰"],
      datasets: [{ data: data.length ? data : [1] }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom", labels:{ boxWidth: 12, padding: 12 }},
        tooltip: {
          callbacks: {
            label: (item)=>{
              if(!data.length) return " 0";
              const v = item.raw || 0;
              const total = data.reduce((s,x)=>s+x,0) || 1;
              const p = Math.round((v/total)*100);
              return ` ${yen(v)}ï¼ˆ${p}%ï¼‰`;
            }
          }
        }
      }
    }
  });
}

/* NEW: æœˆã®ã‚«ãƒ¼ãƒ‰åˆ¥/éŠ€è¡Œåˆ¥ åˆè¨ˆ */
function renderMonthTotalsByCardAndBank(monthAllEntries){
  // ã‚«ãƒ¼ãƒ‰åˆ¥
  const cardSum = new Map(); // cardBrandId -> amount
  const cardEntries = monthAllEntries.filter(e=>e.payType==="card");
  for(const e of cardEntries){
    const k = e.cardBrandId || "__unknown__";
    cardSum.set(k, (cardSum.get(k) || 0) + e.amount);
  }

  // éŠ€è¡Œåˆ¥
  const bankSum = new Map(); // bankId -> amount
  const bankEntries = monthAllEntries.filter(e=>e.payType==="bank");
  for(const e of bankEntries){
    const k = e.bankId || "__unknown__";
    bankSum.set(k, (bankSum.get(k) || 0) + e.amount);
  }

  // render card totals
  $cardTotals.innerHTML = "";
  if(cardEntries.length === 0){
    $cardTotalsNote.textContent = "ã“ã®æœˆã®ã‚«ãƒ¼ãƒ‰æ”¯æ‰•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
  }else{
    $cardTotalsNote.textContent = "";
    const rows = [...cardSum.entries()]
      .map(([id,amt])=>{
        const name = (id==="__unknown__") ? "æœªè¨­å®š" : (state.cardBrands.find(x=>x.id===id)?.name || "æœªè¨­å®š");
        return { name, amt };
      })
      .sort((a,b)=>b.amt - a.amt);

    for(const r of rows){
      const div = document.createElement("div");
      div.className = "kv";
      div.innerHTML = `<div class="k">${r.name}</div><div class="v">${yen(r.amt)}</div>`;
      $cardTotals.appendChild(div);
    }
  }

  // render bank totals
  $bankTotals.innerHTML = "";
  if(bankEntries.length === 0){
    $bankTotalsNote.textContent = "ã“ã®æœˆã®éŠ€è¡Œæ”¯æ‰•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
  }else{
    $bankTotalsNote.textContent = "";
    const rows = [...bankSum.entries()]
      .map(([id,amt])=>{
        const name = (id==="__unknown__") ? "æœªè¨­å®š" : (state.banks.find(x=>x.id===id)?.name || "æœªè¨­å®š");
        return { name, amt };
      })
      .sort((a,b)=>b.amt - a.amt);

    for(const r of rows){
      const div = document.createElement("div");
      div.className = "kv";
      div.innerHTML = `<div class="k">${r.name}</div><div class="v">${yen(r.amt)}</div>`;
      $bankTotals.appendChild(div);
    }
  }
}

function renderCatList(){
  $catList.innerHTML = "";
  state.categories.forEach(c=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div class="emoji">${c.emoji}</div>
      <div class="meta">
        <div class="name">${c.name}</div>
        <div class="small">ä½¿ã£ãŸå›æ•°ï¼š${state.entries.filter(e=>e.categoryId===c.id).length}</div>
      </div>
      <button class="del">å‰Šé™¤</button>
    `;
    row.querySelector(".del").onclick = ()=>{
      const used = state.entries.some(e=>e.categoryId===c.id);
      if(used) return alert("ã“ã®ã‚«ãƒ†ã‚´ãƒªã¯æ˜ç´°ã§ä½¿ã‚ã‚Œã¦ã‚‹ã‹ã‚‰å‰Šé™¤ã§ããªã„ã‚ˆğŸ¥º");
      if(!confirm(`ã€Œ${c.name}ã€ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ`)) return;
      state.categories = state.categories.filter(x=>x.id!==c.id);
      saveState();
      renderCategorySelect();
      renderCatList();
      renderAll();
    };
    $catList.appendChild(row);
  });
}

function renderBankList(){
  $bankList.innerHTML = "";
  state.banks.forEach(b=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div class="meta">
        <div class="name">${b.name}</div>
        <div class="small">ä½¿ã£ãŸå›æ•°ï¼š${state.entries.filter(e=>e.bankId===b.id).length}</div>
      </div>
      <button class="del">å‰Šé™¤</button>
    `;
    row.querySelector(".del").onclick = ()=>{
      const used = state.entries.some(e=>e.bankId===b.id);
      if(used) return alert("ã“ã®éŠ€è¡Œã¯æ˜ç´°ã§ä½¿ã‚ã‚Œã¦ã‚‹ã‹ã‚‰å‰Šé™¤ã§ããªã„ã‚ˆğŸ¥º");
      if(!confirm(`ã€Œ${b.name}ã€ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ`)) return;
      state.banks = state.banks.filter(x=>x.id!==b.id);
      saveState();
      renderBankSelect();
      renderBankList();
      renderAll();
    };
    $bankList.appendChild(row);
  });
}

function renderCardBrandList(){
  $cardBrandList.innerHTML = "";
  state.cardBrands.forEach(c=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div class="meta">
        <div class="name">${c.name}</div>
        <div class="small">ä½¿ã£ãŸå›æ•°ï¼š${state.entries.filter(e=>e.cardBrandId===c.id).length}</div>
      </div>
      <button class="del">å‰Šé™¤</button>
    `;
    row.querySelector(".del").onclick = ()=>{
      const used = state.entries.some(e=>e.cardBrandId===c.id);
      if(used) return alert("ã“ã®ã‚«ãƒ¼ãƒ‰ä¼šç¤¾ã¯æ˜ç´°ã§ä½¿ã‚ã‚Œã¦ã‚‹ã‹ã‚‰å‰Šé™¤ã§ããªã„ã‚ˆğŸ¥º");
      if(!confirm(`ã€Œ${c.name}ã€ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ`)) return;
      state.cardBrands = state.cardBrands.filter(x=>x.id!==c.id);
      saveState();
      renderCardBrandSelect();
      renderCardBrandList();
      renderAll();
    };
    $cardBrandList.appendChild(row);
  });
}

/* View mode */
function setViewMode(mode){
  viewMode = mode;
  $viewAll.classList.toggle("active", mode==="all");
  $viewCard.classList.toggle("active", mode==="card");
  $viewBank.classList.toggle("active", mode==="bank");
  $viewCash.classList.toggle("active", mode==="cash");
  renderAll();
}
function syncPaymentVisibility(){
  const type = $payType.value;
  $cardBrandRow.style.display = type === "card" ? "" : "none";
  $bankRow.style.display = type === "bank" ? "" : "none";
}

/* Helpers */
function getSelectedMonthEntries(mode){
  const ym = selectedYM();
  return state.entries
    .filter(e => e.date && e.date.startsWith(ym))
    .filter(e => mode==="all" ? true : e.payType === mode);
}

/* Storage + migration */
function loadState(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    const init = { categories: defaultCategories(), banks: defaultBanks(), cardBrands: defaultCardBrands(), entries: [] };
    localStorage.setItem(KEY, JSON.stringify(init));
    return init;
  }
  try{
    const s = JSON.parse(raw);
    if(!s.categories || !Array.isArray(s.categories) || s.categories.length===0) s.categories = defaultCategories();
    if(!s.banks || !Array.isArray(s.banks) || s.banks.length===0) s.banks = defaultBanks();
    if(!s.cardBrands || !Array.isArray(s.cardBrands) || s.cardBrands.length===0) s.cardBrands = defaultCardBrands();
    if(!s.entries || !Array.isArray(s.entries)) s.entries = [];

    // Migration: å¤ã„å½¢å¼ã®cardBrandæ–‡å­—åˆ—ãŒã‚ã‚Œã°cardBrandIdã¸å¯„ã›ã‚‹ï¼ˆå¯èƒ½ãªç¯„å›²ï¼‰
    for(const e of s.entries){
      if(e.payType === "card" && !e.cardBrandId){
        if(typeof e.cardBrand === "string" && e.cardBrand.trim()){
          const found = s.cardBrands.find(x=>x.name===e.cardBrand.trim());
          if(found) e.cardBrandId = found.id;
        }
      }
    }
    localStorage.setItem(KEY, JSON.stringify(s));
    return s;
  }catch{
    const init = { categories: defaultCategories(), banks: defaultBanks(), cardBrands: defaultCardBrands(), entries: [] };
    localStorage.setItem(KEY, JSON.stringify(init));
    return init;
  }
}
function saveState(){
  localStorage.setItem(KEY, JSON.stringify(state));
}

/* CSV export */
function exportCSV(){
  const headers = ["date","amount","payType","cardBrand","bank","category","memo"];
  const rows = state.entries.map(e=>{
    const cat = state.categories.find(c=>c.id===e.categoryId);
    const bank = state.banks.find(b=>b.id===e.bankId);
    const cb = state.cardBrands.find(c=>c.id===e.cardBrandId);
    return [
      e.date || "",
      String(e.amount || 0),
      e.payType || "",
      cb?.name || "",
      bank?.name || "",
      (cat?.name || ""),
      (e.memo || "").replaceAll('"','""')
    ];
  });

  const csv = [headers.join(","), ...rows.map(r=>r.map(v=> `"${v}"`).join(","))].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "kakeibo_backup.csv";
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
